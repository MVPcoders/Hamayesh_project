{% load static %}
<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صدور گواهی مقالات</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            font-family: "Vazir", sans-serif;
        }
        .certificate-container {
            background: #fff;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            margin-top: 40px;
        }
        .certificate-template {
            width: 1280px;
            height: 920px;
            border: 5px solid #333;
            border-radius: 20px;
            margin: 20px auto;
            padding: 30px;
            text-align: center;
            display: compact; /* در حالت عادی پنهان */
        }
        /* استایل گواهی‌ها */
        #cert1-template {
            background: url("{% static 'cerbg/photo20342472886.jpg' %}") no-repeat center/cover;
            color: #fff;
        }
        #cert2-template {
            background: url("{% static 'cerbg/photo20342473206.jpg' %}") no-repeat center/cover;
            color: #222;
        }
        #cert3-template {
            background: url("{% static 'cerbg/photo20342492046.jpg' %}") no-repeat center/cover;
            color: #000;
        }
        .certificate-title {
            font-size: 28px;
            font-weight: bold;
            margin-top: 50px;
        }
        .certificate-text {
            font-size: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body dir="rtl">

<div class="container">
    <div class="certificate-container">
        <h2 class="text-center mb-4">صدور گواهی مقالات</h2>

        <!-- انتخاب مقاله -->
        <label class="form-label fw-bold">مقاله‌ی تایید شده خود را انتخاب کنید:</label>
        <select id="articleSelect" class="form-select mb-4" required>
            {% for article in articles %}
                <option value="{{ article.id }}">{{ article.persian_subject }}</option>
            {% empty %}
                <option disabled>هیچ مقاله‌ای تایید نشده است</option>
            {% endfor %}
        </select>

        <!-- تب‌ها -->
        <ul class="nav nav-tabs" id="certificateTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cert1" type="button">گواهی تقدیر</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#cert2" type="button">گواهی مشارکت</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#cert3" type="button">گواهی پذیرش</button></li>
        </ul>

        <div class="tab-content mt-3">
            <!-- گواهی 1 -->
            <div class="tab-pane fade show active" id="cert1">
                <div id="cert1-template" class="certificate-template">
                    <div class="certificate-title">گواهی تقدیر</div>
                    <div class="certificate-text"> بدینوسیله از مقاله "{{ article.persian_subject }}" تقدیر می‌گردد.</div>
                </div>
                <button class="btn btn-primary mt-3" onclick="generateCertificate('cert1')">ایجاد گواهی تقدیر</button>
            </div>

            <!-- گواهی 2 -->
            <div class="tab-pane fade" id="cert2">
                <div id="cert2-template" class="certificate-template">
                    <div class="certificate-title">گواهی مشارکت</div>
                    <div class="certificate-text">بدینوسیله مشارکت شما در مقاله "{{ article.persian_subject }}" تایید می‌شود.</div>
                </div>
                <button class="btn btn-success mt-3" onclick="generateCertificate('cert2')">ایجاد گواهی مشارکت</button>
            </div>

            <!-- گواهی 3 -->
            <div class="tab-pane fade" id="cert3">
                <div id="cert3-template" class="certificate-template">
                    <div class="certificate-title">گواهی پذیرش</div>
                    <div class="certificate-text">مقاله "{{ article.persian_subject }}" مورد پذیرش قرار گرفت.</div>
                </div>
                <button class="btn btn-warning mt-3" onclick="generateCertificate('cert3')">ایجاد گواهی پذیرش</button>
            </div>
        </div>
    </div>
</div>

<!-- js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
function generateCertificate(certType) {
    const articleId = document.getElementById("articleSelect").value;
    const certDiv = document.getElementById(certType+"-template");

    // نمایش برای گرفتن عکس
    certDiv.style.display = "block";

    html2canvas(certDiv).then(canvas => {
        const imgData = canvas.toDataURL("image/png");

        // ارسال به سرور
        fetch("{% url 'save_certificate' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                "article_id": articleId,
                "cert_type": certType,
                "image": imgData
            })
        }).then(res => {
            if(res.ok) alert("گواهی ذخیره شد ✅");
        });

        // پنهان کردن دوباره
        certDiv.style.display = "none";
    });
}
</script>
</body>
</html>
